
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Discussion 2</title>
    <meta name="author" content="Linquan Ma">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://mlqmlq.github.io/STAT628/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="http://mlqmlq.github.io/STAT628/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="http://mlqmlq.github.io/STAT628/assets/themes/twitter/css/main.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->

    <!-- atom & rss feed -->
    <link href="nil" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="nil" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Data Science Practicum - STAT 628 - Fall 2020</a>
          <ul class="nav">
              <li><a href="/pages/schedule.html">schedule</a></li>
          </ul>

        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h2>Discussion 2 </h2>
</div>

<div class="row-fluid">
  <div class="span12">
    <h2 id="before-getting-started">Before getting started</h2>

<p>Please open your Rstudio and install the following packages:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"dplyr"</span><span class="p">)</span><span class="w">
</span><span class="n">install.packages</span><span class="p">(</span><span class="s2">"nycflights13"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="unix-pipes">Unix pipes</h2>
<p>Pipes are used for combining existing commands.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wc</span> <span class="nt">-l</span> <span class="k">*</span>.txt

%      4 a.txt
       4 b.txt
       4 c.txt
      12 total
</code></pre></div></div>
<p>Recall that we can use the <code class="language-plaintext highlighter-rouge">&gt;</code> operator to redirect the output to a file:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wc</span> <span class="nt">-l</span> <span class="k">*</span>.txt <span class="o">&gt;</span> summary.txt
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">sort -n</code> is frequently used to sort the file. Notice its difference with <code class="language-plaintext highlighter-rouge">sort</code>.</p>

<p>the <code class="language-plaintext highlighter-rouge">-n</code> option to specify that the sort is numerical instead of alphanumerical.</p>

<p>We can use the following command to sort <code class="language-plaintext highlighter-rouge">summary.txt</code> in order:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sort</span> <span class="nt">-n</span> summary.txt <span class="o">&gt;</span> summary.txt
</code></pre></div></div>
<p>We can make it easier by running <code class="language-plaintext highlighter-rouge">wc</code> and <code class="language-plaintext highlighter-rouge">sort</code> together</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wc</span> <span class="nt">-l</span> <span class="k">*</span>.txt | <span class="nb">sort</span> <span class="nt">-n</span> <span class="o">&gt;</span> summary.txt
</code></pre></div></div>
<p>The vertical bar, <code class="language-plaintext highlighter-rouge">|</code>, between the two commands is called a pipe. It tells the shell that we want to use the output of the command on the left as the input to the command on the right.</p>

<p>We can also add another layer of pipe to get the first to lines of the sorted line counts:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">wc</span> <span class="nt">-l</span> <span class="k">*</span>.txt | <span class="nb">sort</span> <span class="nt">-n</span> | <span class="nb">head</span> <span class="nt">-1</span>
</code></pre></div></div>

<p>The redirection and pipes used in the last few commands are illustrated below:</p>
<div style="text-align:center"><img src="https://swcarpentry.github.io/shell-novice/fig/redirects-and-pipes.svg" width="600" /></div>

<h1 id="dplyr">dplyr</h1>
<p>is a grammar of data manipulation, providing a consistent set of verbs that help you solve the most common data manipulation challenges. There are five common commands:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">mutate()</code> adds new variables that are functions of existing variables</li>
  <li><code class="language-plaintext highlighter-rouge">select()</code> picks variables based on their names</li>
  <li><code class="language-plaintext highlighter-rouge">filter()</code> picks cases based on their values</li>
  <li><code class="language-plaintext highlighter-rouge">summarise()</code> reduces multiple values down to a single summary</li>
  <li><code class="language-plaintext highlighter-rouge">arrange()</code> changes the ordering of the rows</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">nycflights13</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="nycflights13">nycflights13</h2>
<p>We use the dataset <code class="language-plaintext highlighter-rouge">flights</code>, which contains all 336,776 flights that departed from New York City in 2013.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flights</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 19</span><span class="w">
</span><span class="c1">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1      517            515         2      830            819</span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     1      533            529         4      850            830</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     1      542            540         2      923            850</span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     1      554            600        -6      812            837</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     1      554            558        -4      740            728</span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span><span class="w">
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">&lt;dbl&gt;</code> suggests the corresponding column is of class <code class="language-plaintext highlighter-rouge">double</code>, i.e., a double-precision floating point number.</p>
<h2 id="tibble">tibble</h2>
<p>We see that the variable type is of <code class="language-plaintext highlighter-rouge">tibble</code>, which is a modern reimagining of the data.frame, keeping what time has proven to be effective, and throwing out what is not.</p>

<p>We can create a tibble from an existing object with <code class="language-plaintext highlighter-rouge">as_tibble()</code>:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">as_tibble</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 150 x 5</span><span class="w">
</span><span class="c1">#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span><span class="w">
</span><span class="c1">#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span><span class="w">
</span><span class="c1">#&gt;  1          5.1         3.5          1.4         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt;  2          4.9         3            1.4         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt;  3          4.7         3.2          1.3         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt;  4          4.6         3.1          1.5         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt;  5          5           3.6          1.4         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt;  6          5.4         3.9          1.7         0.4 setosa </span><span class="w">
</span><span class="c1">#&gt;  7          4.6         3.4          1.4         0.3 setosa </span><span class="w">
</span><span class="c1">#&gt;  8          5           3.4          1.5         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt;  9          4.4         2.9          1.4         0.2 setosa </span><span class="w">
</span><span class="c1">#&gt; 10          4.9         3.1          1.5         0.1 setosa </span><span class="w">
</span><span class="c1">#&gt; # … with 140 more rows</span><span class="w">
</span></code></pre></div></div>
<h2 id="filter-rows-with-filter">Filter rows with filter():</h2>
<p><code class="language-plaintext highlighter-rouge">filter()</code> allows you to subset observations based on their values. The first argument is the name of the data frame. The second and subsequent arguments are the expressions that filter the data frame. For example, we can select all flights on January 1st with:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 842 x 19</span><span class="w">
</span><span class="c1">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1      517            515         2      830            819</span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     1      533            529         4      850            830</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     1      542            540         2      923            850</span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     1      554            600        -6      812            837</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     1      554            558        -4      740            728</span><span class="w">
</span><span class="c1">#&gt; # … with 836 more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span><span class="w">
</span></code></pre></div></div>
<p>It’s much more efficient that subsetting in data.frame.</p>

<p><code class="language-plaintext highlighter-rouge">dplyr</code> functions never modify their inputs, so if you want to save the result, you’ll need to use the assignment operator, <code class="language-plaintext highlighter-rouge">&lt;-</code>:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>The following code finds all flights that departed in November or December:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>A useful short-hand for this problem is <code class="language-plaintext highlighter-rouge">x %in% y</code>. This will select every row where <code class="language-plaintext highlighter-rouge">x</code> is one of the values in <code class="language-plaintext highlighter-rouge">y</code>. We could use it to rewrite the code above:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>
<h3 id="exercises">Exercises</h3>
<p>Find all flights that</p>
<ul>
  <li>Had an arrival delay of two or more hours</li>
  <li>Arrived more than two hours late, but didn’t leave late</li>
</ul>

<p>How many flights have a missing dep_time?</p>

<h2 id="arrange-rows-with-arrange">Arrange rows with arrange():</h2>
<p><code class="language-plaintext highlighter-rouge">arrange()</code> works similarly to <code class="language-plaintext highlighter-rouge">filter()</code> except that instead of selecting rows, it changes their order. It takes a data frame and a set of column names (or more complicated expressions) to order by. If you provide more than one column name, each additional column will be used to break ties in the values of preceding columns:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">arrange</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 19</span><span class="w">
</span><span class="c1">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1      517            515         2      830            819</span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     1      533            529         4      850            830</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     1      542            540         2      923            850</span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     1      544            545        -1     1004           1022</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     1      554            600        -6      812            837</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     1      554            558        -4      740            728</span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span><span class="w">
</span></code></pre></div></div>
<p>Use <code class="language-plaintext highlighter-rouge">desc()</code> to re-order by a column in descending order:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">arrange</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">))</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 19</span><span class="w">
</span><span class="c1">#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     9      641            900      1301     1242           1530</span><span class="w">
</span><span class="c1">#&gt; 2  2013     6    15     1432           1935      1137     1607           2120</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1    10     1121           1635      1126     1239           1810</span><span class="w">
</span><span class="c1">#&gt; 4  2013     9    20     1139           1845      1014     1457           2210</span><span class="w">
</span><span class="c1">#&gt; 5  2013     7    22      845           1600      1005     1044           1815</span><span class="w">
</span><span class="c1">#&gt; 6  2013     4    10     1100           1900       960     1342           2211</span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span><span class="w">
</span></code></pre></div></div>
<p>Missing values are always sorted at the end.</p>

<h3 id="exercises-1">Exercises</h3>
<p>Sort <code class="language-plaintext highlighter-rouge">flights</code> to find the fastest (highest speed) flights. (Consider columns <code class="language-plaintext highlighter-rouge">air_time</code> and <code class="language-plaintext highlighter-rouge">distance</code>)</p>

<h2 id="select-columns-with-select">Select columns with select()</h2>

<p>allows you to rapidly zoom in on a useful subset using operations based on the names of the variables.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select columns by name</span><span class="w">
</span><span class="n">select</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 3</span><span class="w">
</span><span class="c1">#&gt;    year month   day</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows</span><span class="w">
</span><span class="c1"># Select all columns between year and day (inclusive)</span><span class="w">
</span><span class="n">select</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="o">:</span><span class="n">day</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 3</span><span class="w">
</span><span class="c1">#&gt;    year month   day</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     1</span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows</span><span class="w">
</span><span class="c1"># Select all columns except those from year to day (inclusive)</span><span class="w">
</span><span class="n">select</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">year</span><span class="o">:</span><span class="n">day</span><span class="p">))</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 16</span><span class="w">
</span><span class="c1">#&gt;   dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay carrier</span><span class="w">
</span><span class="c1">#&gt;      &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;  </span><span class="w">
</span><span class="c1">#&gt; 1      517            515         2      830            819        11 UA     </span><span class="w">
</span><span class="c1">#&gt; 2      533            529         4      850            830        20 UA     </span><span class="w">
</span><span class="c1">#&gt; 3      542            540         2      923            850        33 AA     </span><span class="w">
</span><span class="c1">#&gt; 4      544            545        -1     1004           1022       -18 B6     </span><span class="w">
</span><span class="c1">#&gt; 5      554            600        -6      812            837       -25 DL     </span><span class="w">
</span><span class="c1">#&gt; 6      554            558        -4      740            728        12 UA     </span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows, and 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span><span class="w">
</span><span class="c1">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span><span class="w">
</span></code></pre></div></div>
<p>There are a number of helper functions you can use within select():</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">starts_with("abc")</code>: matches names that begin with “abc”.</li>
  <li><code class="language-plaintext highlighter-rouge">ends_with("xyz")</code>: matches names that end with “xyz”.</li>
  <li><code class="language-plaintext highlighter-rouge">contains("ijk")</code>: matches names that contain “ijk”.</li>
  <li><code class="language-plaintext highlighter-rouge">matches("")</code> allows you to use regular expressions.</li>
</ul>

<h3 id="exercise">Exercise</h3>
<p>Brainstorm as many ways as possible to select <code class="language-plaintext highlighter-rouge">dep_time</code> and <code class="language-plaintext highlighter-rouge">dep_delay</code> from flights.</p>

<h2 id="add-new-variables-with-mutate">Add new variables with mutate()</h2>
<p>can be used to add new columns.</p>

<p><code class="language-plaintext highlighter-rouge">mutate()</code> always adds new columns at the end of your dataset.</p>

<p>We first create a narrower dataset from <code class="language-plaintext highlighter-rouge">flights</code> using <code class="language-plaintext highlighter-rouge">select()</code></p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flights_sml</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> 
  </span><span class="n">year</span><span class="o">:</span><span class="n">day</span><span class="p">,</span><span class="w"> 
  </span><span class="n">ends_with</span><span class="p">(</span><span class="s2">"delay"</span><span class="p">),</span><span class="w"> 
  </span><span class="n">distance</span><span class="p">,</span><span class="w"> 
  </span><span class="n">air_time</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">mutate</span><span class="p">(</span><span class="n">flights_sml</span><span class="p">,</span><span class="w">
  </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dep_delay</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">arr_delay</span><span class="p">,</span><span class="w">
  </span><span class="n">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">air_time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 336,776 x 9</span><span class="w">
</span><span class="c1">#&gt;    year month   day dep_delay arr_delay distance air_time  gain speed</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1         2        11     1400      227    -9  370.</span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     1         4        20     1416      227   -16  374.</span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     1         2        33     1089      160   -31  408.</span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     1        -1       -18     1576      183    17  517.</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     1        -6       -25      762      116    19  394.</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     1        -4        12      719      150   -16  288.</span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows</span><span class="w">
</span></code></pre></div></div>

<p>If you only want to keep the new variables, use <code class="language-plaintext highlighter-rouge">transmute()</code>:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">transmute</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w">
  </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dep_delay</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">arr_delay</span><span class="p">,</span><span class="w">
  </span><span class="n">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">air_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="c1"># A tibble: 336,776 x 2</span><span class="w">
</span><span class="c1">#&gt;    gain hours</span><span class="w">
</span><span class="c1">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span><span class="w">
</span><span class="c1">#&gt; 1    -9 3.78 </span><span class="w">
</span><span class="c1">#&gt; 2   -16 3.78 </span><span class="w">
</span><span class="c1">#&gt; 3   -31 2.67 </span><span class="w">
</span><span class="c1">#&gt; 4    17 3.05 </span><span class="w">
</span><span class="c1">#&gt; 5    19 1.93 </span><span class="w">
</span><span class="c1">#&gt; 6   -16 2.5 </span><span class="w">
</span><span class="c1">#&gt; # … with 336,770 more rows </span><span class="w">
</span></code></pre></div></div>

<h3 id="exercise-1">Exercise</h3>
<p>Consider the <code class="language-plaintext highlighter-rouge">iris</code> dataset. How to replace the column <code class="language-plaintext highlighter-rouge">Species</code> by its one-hot-encoded version? (Replace <code class="language-plaintext highlighter-rouge">Species</code> by <code class="language-plaintext highlighter-rouge">X1</code> and <code class="language-plaintext highlighter-rouge">X2</code> where <code class="language-plaintext highlighter-rouge">X1 = 1</code> if <code class="language-plaintext highlighter-rouge">Species == "setosa"</code> and <code class="language-plaintext highlighter-rouge">X2 = 1</code> if <code class="language-plaintext highlighter-rouge">Species == "versicolor"</code>).</p>

<h3 id="questions">Questions?</h3>

<div style="text-align:center"><img src="https://media1.tenor.com/images/cd3ee8f2a22b429050b954cabbf81c6b/tenor.gif?itemid=14812024" width="250" /></div>

<h2 id="grouped-summaries-with-summarise">Grouped summaries with summarise()</h2>
<p>which collapses a data frame to a single row:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summarise</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 1 x 1</span><span class="w">
</span><span class="c1">#&gt;   delay</span><span class="w">
</span><span class="c1">#&gt;   &lt;dbl&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  12.6</span><span class="w">
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">summarise()</code> is not terribly useful unless we pair it with <code class="language-plaintext highlighter-rouge">group_by()</code>. This changes the unit of analysis from the complete dataset to individual groups.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">by_day</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">by_day</span><span class="p">)</span><span class="w">
</span><span class="c1"># A tibble: 6 x 19</span><span class="w">
</span><span class="c1"># Groups:   year, month, day [1]</span><span class="w">
</span><span class="c1">#   year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span><span class="w">
</span><span class="c1">#  &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span><span class="w">
</span><span class="c1"># 1  2013     1     1      517            515         2      830            819</span><span class="w">
</span><span class="c1"># 2  2013     1     1      533            529         4      850            830</span><span class="w">
</span><span class="c1"># 3  2013     1     1      542            540         2      923            850</span><span class="w">
</span><span class="c1"># 4  2013     1     1      544            545        -1     1004           1022</span><span class="w">
</span><span class="c1"># 5  2013     1     1      554            600        -6      812            837</span><span class="w">
</span><span class="c1"># 6  2013     1     1      554            558        -4      740            728</span><span class="w">
</span><span class="c1"># … with 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,</span><span class="w">
</span><span class="c1">#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,</span><span class="w">
</span><span class="c1">#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span><span class="w">
</span></code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">group_by()</code> command will generate a new class called <code class="language-plaintext highlighter-rouge">grouped_df</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summarise</span><span class="p">(</span><span class="n">by_day</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span><span class="c1">#&gt; # A tibble: 365 x 4</span><span class="w">
</span><span class="c1">#&gt; # Groups:   year, month [12]</span><span class="w">
</span><span class="c1">#&gt;    year month   day delay</span><span class="w">
</span><span class="c1">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span><span class="w">
</span><span class="c1">#&gt; 1  2013     1     1 11.5 </span><span class="w">
</span><span class="c1">#&gt; 2  2013     1     2 13.9 </span><span class="w">
</span><span class="c1">#&gt; 3  2013     1     3 11.0 </span><span class="w">
</span><span class="c1">#&gt; 4  2013     1     4  8.95</span><span class="w">
</span><span class="c1">#&gt; 5  2013     1     5  5.73</span><span class="w">
</span><span class="c1">#&gt; 6  2013     1     6  7.15</span><span class="w">
</span><span class="c1">#&gt; # … with 359 more rows</span><span class="w">
</span></code></pre></div></div>
<p>Together group_by() and summarise() provide one of the tools that you’ll use most commonly when working with dplyr: grouped summaries. But before we go any further with this, we need to introduce a powerful new idea: the pipe.</p>

<h2 id="combining-multiple-operations-with-the-pipe">Combining multiple operations with the pipe</h2>
<p>Using what you know about dplyr, you might write code like this:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">by_dest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">)</span><span class="w">
</span><span class="n">delay</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summarise</span><span class="p">(</span><span class="n">by_dest</span><span class="p">,</span><span class="w">
  </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">(),</span><span class="w">
  </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">arr_delay</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="n">delay</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"ABQ"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>There’s another way to tackle the same problem with the pipe, <code class="language-plaintext highlighter-rouge">%&gt;%</code>:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">delays</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">flights</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">(),</span><span class="w">
    </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">arr_delay</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">filter</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"ABQ"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>Behind the scenes, <code class="language-plaintext highlighter-rouge">x %&gt;% f(y)</code> turns into <code class="language-plaintext highlighter-rouge">f(x, y)</code>, and <code class="language-plaintext highlighter-rouge">x %&gt;% f(y) %&gt;% g(z)</code> turns into <code class="language-plaintext highlighter-rouge">g(f(x, y), z)</code> and so on. You can use the pipe to rewrite multiple operations in a way that you can read left-to-right, top-to-bottom. We’ll use piping frequently from now on because it considerably improves the readability of code,</p>

<p>Working with the pipe is one of the key criteria for belonging to the tidyverse. The only exception is ggplot2: it was written before the pipe was discovered. Unfortunately, the next iteration of ggplot2, ggvis, which does use the pipe, isn’t quite ready for prime time yet.</p>

<h3 id="exercise-2">Exercise</h3>
<p>For each <code class="language-plaintext highlighter-rouge">flight</code>, count the number which has <code class="language-plaintext highlighter-rouge">arr_delay</code> greater than 1 hour, and their average delay.</p>

<h3 id="cheatsheet-of-dplyr">Cheatsheet of dplyr</h3>
<p>https://rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf</p>

<h2 id="mock-interview-questions">Mock interview questions</h2>

<ul>
  <li>What variance inflation factor (VIF) in linear regression? What can we infer if the VIF for one predictor is larger than 5?</li>
</ul>

<hr />

  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>
          <!-- start of footer -->
          Fall 2020 &nbsp;-&nbsp;
          <a href="http://mlqmlq.github.io">Linquan Ma</a>
          <!-- end of footer -->
        </small></p>
      </footer>

    </div>

    
  </body>
</html>

